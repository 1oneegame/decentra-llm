from typing import Dict, Any
import random

class PushGenerator:    
    def __init__(self):
        self.cluster_descriptions = {
            0: "экономные клиенты",
            1: "активные потребители", 
            2: "премиальные клиенты",
            3: "молодые профессионалы",
            4: "семейные клиенты",
            5: "высокодоходные инвесторы"
        }
        
        self.cluster_messaging_styles = {
            0: {  # Экономные клиенты
                "tone": "экономия и выгода",
                "focus": ["экономия", "низкие комиссии", "реальная выгода", "практичность"],
                "emotional_hooks": ["сэкономьте", "выгодно", "без переплат", "разумное решение"]
            },
            1: {  # Активные потребители
                "tone": "удобство и скорость",
                "focus": ["удобство", "быстрота", "больше возможностей", "активный образ жизни"],
                "emotional_hooks": ["удобно", "быстро", "больше свободы", "ваш темп жизни"]
            },
            2: {  # Премиальные клиенты
                "tone": "статус и эксклюзивность",
                "focus": ["премиум сервис", "эксклюзивность", "статус", "особые привилегии"],
                "emotional_hooks": ["эксклюзивно", "премиум", "особые условия", "ваш статус"]
            },
            3: {  # Молодые профессионалы
                "tone": "карьера и развитие",
                "focus": ["карьерный рост", "инвестиции в будущее", "современные решения", "технологии"],
                "emotional_hooks": ["инвестируйте в будущее", "карьерный рост", "современное решение", "ваше развитие"]
            },
            4: {  # Семейные клиенты
                "tone": "семья и безопасность",
                "focus": ["семейная безопасность", "планирование", "стабильность", "забота о близких"],
                "emotional_hooks": ["для вашей семьи", "безопасность близких", "стабильное будущее", "забота о детях"]
            },
            5: {  # Высокодоходные инвесторы
                "tone": "инвестиции и приумножение",
                "focus": ["приумножение капитала", "инвестиционные возможности", "диверсификация", "высокая доходность"],
                "emotional_hooks": ["приумножьте капитал", "инвестиционная возможность", "высокая доходность", "финансовая независимость"]
            }
        }
        
        self.cluster_templates = {
            'Карта для путешествий': {
                0: [  # Экономные клиенты
                    "{name}, сэкономьте на поездках! Ваши траты {travel_amount:,.0f} ₸ — с тревел-картой вернете {travel_cashback:,.0f} ₸. Разумное решение без переплат!",
                    "{name}, выгодно! Поездки на {travel_amount:,.0f} ₸ = возврат {travel_cashback:,.0f} ₸ с тревел-картой. Без скрытых комиссий!"
                ],
                1: [  # Активные потребители  
                    "{name}, ваш активный образ жизни — {travel_amount:,.0f} ₸ на поездки. Тревел-карта вернет {travel_cashback:,.0f} ₸ быстро и удобно!",
                    "{name}, больше свободы в путешествиях! Возврат {travel_cashback:,.0f} ₸ с поездок {travel_amount:,.0f} ₸. Ваш темп — наши возможности!"
                ],
                2: [  # Премиальные клиенты
                    "{name}, эксклюзивно для вас: премиум тревел-карта. Возврат {travel_cashback:,.0f} ₸ с трат {travel_amount:,.0f} ₸ + VIP сервис в аэропортах.",
                    "{name}, ваш статус заслуживает особого. Премиум тревел-карта: {travel_cashback:,.0f} ₸ возврата + консьерж-сервис 24/7."
                ],
                3: [  # Молодые профессионалы
                    "{name}, инвестируйте в карьерный рост! Командировки {travel_amount:,.0f} ₸ = возврат {travel_cashback:,.0f} ₸. Современное решение для амбициозных!",
                    "{name}, ваше развитие не знает границ. Тревел-карта для профессионалов: {travel_cashback:,.0f} ₸ возврата с поездок!"
                ],
                4: [  # Семейные клиенты
                    "{name}, для семейных поездок — семейная выгода! Траты {travel_amount:,.0f} ₸ вернут {travel_cashback:,.0f} ₸ для семейного бюджета.",
                    "{name}, стабильное будущее начинается с разумных решений. Семейные поездки: возврат {travel_cashback:,.0f} ₸ из {travel_amount:,.0f} ₸!"
                ],
                5: [  # Высокодоходные инвесторы
                    "{name}, диверсифицируйте доходы! Поездки {travel_amount:,.0f} ₸ + возврат {travel_cashback:,.0f} ₸ = дополнительная инвестиционная возможность.",
                    "{name}, приумножьте капитал с каждой поездкой. Высокая доходность: {travel_cashback:,.0f} ₸ возврата с трат {travel_amount:,.0f} ₸!"
                ]
            },
            'Премиальная карта': {
                0: [  # Экономные клиенты
                    "{name}, разумный выбор! Ваш баланс {balance:,.0f} ₸ заслуживает выгодных условий. Премиум-карта без переплат вернет {premium_cashback:,.0f} ₸!",
                    "{name}, сэкономьте больше с премиальными условиями! Возврат {premium_cashback:,.0f} ₸ + льготы без скрытых комиссий."
                ],
                1: [  # Активные потребители
                    "{name}, ваш активный образ жизни требует удобства! Премиум-карта: {premium_cashback:,.0f} ₸ возврата + быстрые переводы 24/7.",
                    "{name}, больше возможностей с премиальной картой! Траты в ресторанах {restaurant_amount:,.0f} ₸ = возврат {premium_cashback:,.0f} ₸!"
                ],
                2: [  # Премиальные клиенты  
                    "{name}, эксклюзивно для вашего статуса. Премиальная карта: {premium_cashback:,.0f} ₸ возврата + персональный менеджер и VIP-зал.",
                    "{name}, ваш статус {balance:,.0f} ₸ открывает особые привилегии. Премиум-сервис + {premium_cashback:,.0f} ₸ кешбэка!"
                ],
                3: [  # Молодые профессионалы
                    "{name}, инвестируйте в карьерное развитие! Премиальная карта для профессионалов: {premium_cashback:,.0f} ₸ возврата + бизнес-привилегии.",
                    "{name}, современное решение для амбициозных. Премиум-карта: {premium_cashback:,.0f} ₸ кешбэка + нетворкинг возможности!"
                ],
                4: [  # Семейные клиенты
                    "{name}, забота о семье начинается с разумных решений. Семейная премиум-карта: {premium_cashback:,.0f} ₸ для семейного бюджета!",
                    "{name}, стабильность для семьи. Баланс {balance:,.0f} ₸ + премиальная карта = {premium_cashback:,.0f} ₸ дополнительного дохода!"
                ],
                5: [  # Высокодоходные инвесторы
                    "{name}, максимизируйте доходность портфеля! Премиальная карта: {premium_cashback:,.0f} ₸ дополнительного дохода + инвест-консультации.",
                    "{name}, диверсификация через премиальные продукты. Капитал {balance:,.0f} ₸ + {premium_cashback:,.0f} ₸ премиального дохода!"
                ]
            },
            'Кредитная карта': {
                0: [  # Экономные клиенты
                    "{name}, сэкономьте с умом! Кредитная карта без годового взноса вернет {credit_cashback:,.0f} ₸ с ваших трат {total_spending:,.0f} ₸.",
                    "{name}, выгодно и практично! Траты {categories} = возврат {credit_cashback:,.0f} ₸. Без скрытых комиссий!"
                ],
                1: [  # Активные потребители
                    "{name}, больше свободы в тратах! Кредитная карта для активных: {credit_cashback:,.0f} ₸ возврата + мгновенные уведомления.",
                    "{name}, ваш активный образ жизни заслуживает большего. Кредитка: {credit_cashback:,.0f} ₸ кешбэка + удобное управление!"
                ],
                2: [  # Премиальные клиенты
                    "{name}, эксклюзивная кредитная карта для вашего статуса. {credit_cashback:,.0f} ₸ возврата + консьерж-сервис 24/7.",
                    "{name}, премиальные условия кредитования. Траты {total_spending:,.0f} ₸ = возврат {credit_cashback:,.0f} ₸ + особые привилегии!"
                ],
                3: [  # Молодые профессионалы
                    "{name}, инвестируйте в будущее уже сегодня! Кредитка для профессионалов: {credit_cashback:,.0f} ₸ возврата + карьерные бонусы.",
                    "{name}, современное решение для амбициозных. Кредитная карта: {credit_cashback:,.0f} ₸ кешбэка + технологичное управление!"
                ],
                4: [  # Семейные клиенты
                    "{name}, для семейного бюджета — семейная карта! Траты {total_spending:,.0f} ₸ вернут {credit_cashback:,.0f} ₸ для семьи.",
                    "{name}, забота о семье через разумные финансы. Семейная кредитка: {credit_cashback:,.0f} ₸ дополнительного дохода!"
                ],
                5: [  # Высокодоходные инвесторы
                    "{name}, оптимизируйте денежный поток! Инвестиционная кредитка: {credit_cashback:,.0f} ₸ возврата для реинвестирования.",
                    "{name}, финансовая независимость через умное кредитование. {credit_cashback:,.0f} ₸ дополнительной ликвидности!"
                ]
            },
            'Обмен валют': {
                0: [  # Экономные клиенты
                    "{name}, сэкономьте на валютных операциях! Выгодный курс {fx_curr} без скрытых комиссий. Операции {fx_amount:,.0f} ₸ по лучшему курсу.",
                    "{name}, разумный обмен валют. {fx_curr} по выгодному курсу 24/7 — экономьте на каждой операции!"
                ],
                1: [  # Активные потребители
                    "{name}, мгновенный обмен {fx_curr} для активных! Операции {fx_amount:,.0f} ₸ по лучшему курсу + быстрые переводы.",
                    "{name}, ваш темп требует скорости. Обмен {fx_curr} онлайн 24/7 — удобно и быстро!"
                ],
                2: [  # Премиальные клиенты
                    "{name}, эксклюзивные валютные условия. Премиальный курс {fx_curr} + персональный валютный консультант 24/7.",
                    "{name}, ваш статус открывает особые курсы. Операции {fx_amount:,.0f} ₸ по привилегированным условиям!"
                ],
                3: [  # Молодые профессионалы
                    "{name}, современные валютные решения! Умный обмен {fx_curr} для профессионалов + аналитика курсов.",
                    "{name}, инвестируйте в развитие! Валютные операции {fx_amount:,.0f} ₸ по технологичным решениям."
                ],
                4: [  # Семейные клиенты
                    "{name}, семейные валютные операции по выгодному курсу. {fx_curr} для семейного бюджета — стабильно и надежно.",
                    "{name}, планируйте семейные поездки заранее! Обмен {fx_curr} по фиксированному курсу для семьи."
                ],
                5: [  # Высокодоходные инвесторы
                    "{name}, диверсифицируйте валютные риски! Профессиональный обмен {fx_curr} + хеджирование операций {fx_amount:,.0f} ₸.",
                    "{name}, максимизируйте валютную доходность! Инвестиционные курсы {fx_curr} + аналитика рынков."
                ]
            },
            'Кредит наличными': {
                0: [  # Экономные клиенты
                    "{name}, выгодный кредит без скрытых комиссий! Разумное решение — получите наличные под {balance:,.0f} ₸ залога. Проверить лимит.",
                    "{name}, сэкономьте на кредитовании! Наличные без переплат — ставка 12% годовых. Без скрытых платежей!"
                ],
                1: [  # Активные потребители
                    "{name}, мгновенное решение по кредиту! Активным клиентам — быстрое одобрение наличных. Проверить лимит онлайн.",
                    "{name}, ваш темп требует скорости! Кредит наличными за 30 минут + удобное управление через приложение."
                ],
                2: [  # Премиальные клиенты
                    "{name}, эксклюзивные условия кредитования для вашего статуса. Премиальные ставки + персональный менеджер.",
                    "{name}, ваш статус {balance:,.0f} ₸ открывает особые кредитные лимиты. Привилегированные условия кредитования!"
                ],
                3: [  # Молодые профессионалы
                    "{name}, инвестируйте в карьерное развитие! Кредит для профессионалов — образование, стартап, возможности.",
                    "{name}, современное кредитование для амбициозных. Быстрое решение + цифровое управление кредитом!"
                ],
                4: [  # Семейные клиенты
                    "{name}, для семейных целей — семейный кредит! Ремонт, отпуск, образование детей — стабильные условия.",
                    "{name}, планируйте семейное будущее! Кредит наличными для важных семейных решений. Фиксированная ставка."
                ],
                5: [  # Высокодоходные инвесторы
                    "{name}, оптимизируйте ликвидность! Кредитное плечо для инвестиционных возможностей. Гибкие условия возврата.",
                    "{name}, финансовое планирование требует гибкости. Кредит под залог портфеля — сохраните инвестиции!"
                ]
            },
            'Депозит сберегательный': {
                0: [  # Экономные клиенты
                    "{name}, разумное накопление! Депозит 16,5% годовых для ваших {balance:,.0f} ₸. Выгодно и надежно!",
                    "{name}, сэкономленные средства должны работать! Сберегательный вклад без комиссий — максимальная выгода."
                ],
                1: [  # Активные потребители
                    "{name}, активное накопление для активных людей! Депозит с возможностью управления через приложение 24/7.",
                    "{name}, ваши {balance:,.0f} ₸ заслуживают активного роста! Сберегательный депозит + удобное пополнение."
                ],
                2: [  # Премиальные клиенты
                    "{name}, эксклюзивные депозитные условия. Премиальная ставка + персональное обслуживание для капитала {balance:,.0f} ₸.",
                    "{name}, ваш статус открывает особые депозитные программы. Максимальная доходность + VIP-условия!"
                ],
                3: [  # Молодые профессионалы
                    "{name}, инвестируйте в стабильное будущее! Депозит для профессионалов — начните формировать капитал сегодня.",
                    "{name}, современный подход к накоплениям! Цифровой депозит с высокой доходностью + мобильное управление."
                ],
                4: [  # Семейные клиенты
                    "{name}, семейная финансовая безопасность! Сберегательный депозит для стабильного будущего семьи.",
                    "{name}, планируйте семейное благополучие! Надежный вклад {balance:,.0f} ₸ — фундамент семейного капитала."
                ],
                5: [  # Высокодоходные инвесторы
                    "{name}, диверсифицируйте портфель! Консервативная часть инвестиций — гарантированная доходность 16,5%.",
                    "{name}, стабильный доход в волатильном рынке. Депозитная подушка безопасности для {balance:,.0f} ₸ капитала!"
                ]
            },
        }
    
    def generate_push(self, client_analysis: Dict[str, Any], product: str, cluster: int = None) -> str:        
        if product not in self.cluster_templates:
            cluster_desc = self.get_cluster_description(cluster) if cluster is not None else ""
            cluster_text = f" Вы относитесь к категории '{cluster_desc}' - " if cluster_desc else ""
            return f"{client_analysis['name']},{cluster_text} персональная рекомендация: {product}. Узнать подробнее."
        
        cluster = cluster if cluster is not None and cluster in range(6) else 0
        
        cluster_templates = self.cluster_templates[product]
        if cluster not in cluster_templates:
            cluster = 0
        
        template = random.choice(cluster_templates[cluster])
        
        travel_amount = client_analysis.get('travel_spending', 0) + client_analysis.get('taxi_spending', 0)
        restaurant_amount = client_analysis.get('restaurant_spending', 0)
        total_spending = client_analysis.get('total_spending', 0)
        online_services_amount = client_analysis.get('online_services_spending', 0)
        
        params = {
            'name': client_analysis.get('name', 'Клиент'),
            'balance': client_analysis.get('avg_balance', 0),
            'month': 'этом месяце',
            'travel_amount': travel_amount,
            'restaurant_amount': restaurant_amount,
            'total_spending': total_spending,
            'travel_cashback': travel_amount * 0.04,
            'premium_cashback': restaurant_amount * 0.04,
            'credit_cashback': max(online_services_amount * 0.10, total_spending * 0.015),
            'fx_amount': client_analysis.get('fx_operations', 0),
            'fx_curr': 'USD/EUR',
            'top_category': self._get_top_category(client_analysis),
            'categories': self._get_top_categories_string(client_analysis)
        }
        
        try:
            return template.format(**params)
        except KeyError as e:
            return f"{params['name']}, персональная рекомендация: {product}. Узнать подробнее."
    
    def get_cluster_description(self, cluster: int) -> str:
        return self.cluster_descriptions.get(cluster, f"клиенты группы {cluster}")
    
    def _get_top_category(self, analysis: Dict[str, Any]) -> str:
        spending_by_category = {}
        
        category_translation = {
            'total': 'Общие траты',
            'restaurant': 'Рестораны',
            'travel': 'Путешествия', 
            'taxi': 'Такси',
            'online_services': 'Онлайн-сервисы',
            'foreign_currency': 'Валютные операции',
            'entertainment': 'Развлечения',
            'food': 'Продукты питания',
            'medical': 'Медицина',
            'auto': 'Авто',
            'jewelry_cosmetics': 'Ювелирка и косметика',
            'atm_withdrawals': 'Снятие наличных'
        }
        
        for key, value in analysis.items():
            if key.endswith('_spending') and value > 0:
                category_key = key.replace('_spending', '')
                category_name = category_translation.get(category_key, category_key.replace('_', ' ').title())
                spending_by_category[category_name] = value
        
        if spending_by_category:
            return max(spending_by_category.items(), key=lambda x: x[1])[0]
        
        return "Продукты питания"
    
    def _get_top_categories_string(self, analysis: Dict[str, Any]) -> str:
        spending_by_category = {}
        
        category_translation = {
            'total': 'Общие траты',
            'restaurant': 'Рестораны',
            'travel': 'Путешествия', 
            'taxi': 'Такси',
            'online_services': 'Онлайн-сервисы',
            'foreign_currency': 'Валютные операции',
            'entertainment': 'Развлечения',
            'food': 'Продукты питания',
            'medical': 'Медицина',
            'auto': 'Авто',
            'jewelry_cosmetics': 'Ювелирка и косметика',
            'atm_withdrawals': 'Снятие наличных'
        }
        
        for key, value in analysis.items():
            if key.endswith('_spending') and value > 0:
                category_key = key.replace('_spending', '')
                category_name = category_translation.get(category_key, category_key.replace('_', ' ').title())
                spending_by_category[category_name] = value
        
        if spending_by_category:
            top_3 = sorted(spending_by_category.items(), key=lambda x: x[1], reverse=True)[:3]
            return ', '.join([cat for cat, _ in top_3])
        
        return "Продукты питания, Кафе и рестораны, Одежда и обувь"